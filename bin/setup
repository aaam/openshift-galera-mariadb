#!/bin/bash -e

source $OPENSHIFT_CARTRIDGE_SDK_BASH
#source "$OPENSHIFT_MARIADB_DIR/versions/$version/lib/mysql_context"

case "$1" in
  -v|--version)
    version="$2"
esac


# extract mariadb binary file
mkdir -p $OPENSHIFT_MARIADB_DIR/mariadb

# grab the binary from mariadb.org mirror - I'm not sure if this'll work because of the timeout limitation
cd $OPENSHIFT_MARIADB_DIR/versions/$version/
wget http://mirror.aarnet.edu.au/pub/MariaDB/mariadb-galera-5.5.34/kvm-bintar-hardy-amd64/mariadb-galera-5.5.34-linux-x86_64.tar.gz

tar xzf $OPENSHIFT_MARIADB_DIR/versions/$version/mariadb-galera-$version-linux-x86_64.tar.gz --strip-components=1 -C $OPENSHIFT_MARIADB_DIR/mariadb/

cp -Hr $OPENSHIFT_MARIADB_DIR/versions/$version/conf/* $OPENSHIFT_MARIADB_DIR/mariadb/conf
ln -s $OPENSHIFT_MARIADB_DIR/versions/$version/lib $OPENSHIFT_MARIADB_DIR/lib


mkdir -p $OPENSHIFT_MARIADB_DIR/{log,pid,socket,data,run}

cp conf/my.cnf.erb conf/my.cnf.erb.hidden

update_configuration $version
