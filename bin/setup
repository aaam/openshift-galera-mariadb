#!/bin/bash -e

source $OPENSHIFT_CARTRIDGE_SDK_BASH
source "$OPENSHIFT_MARIADB_DIR/lib/mysql_context"

case "$1" in
  -v|--version)
    version="$2"
esac


# extract mariadb binary file
mkdir -p $OPENSHIFT_MARIADB_DIR/mariadb

# grab the binary from mariadb.org mirror
mkdir -p $OPENSHIFT_MARIADB_DIR/versions/$version/
cd $OPENSHIFT_MARIADB_DIR/versions/$version/
wget http://mirror.aarnet.edu.au/pub/MariaDB/mariadb-galera-5.5.34/kvm-bintar-hardy-amd64/mariadb-galera-5.5.34-linux-x86_64.tar.gz --nv

tar xzf $OPENSHIFT_MARIADB_DIR/versions/$version/mariadb-galera-$version-linux-x86_64.tar.gz --strip-components=1 -C $OPENSHIFT_MARIADB_DIR/mariadb/

# Lets try clean up the binary contents to quotas don't complain
rm -rf $OPENSHIFT_MARIADB_DIR/mariadb/mysql-test
rm -rf $OPENSHIFT_MARIADB_DIR/mariadb/sql-bench
rm -rf $OPENSHIFT_MARIADB_DIR/mariadb/man

# Lets grab galera
#mkdir $OPENSHIFT_MARIADB_DIR/galera
#cd $OPENSHIFT_MARIADB_DIR/galera
#wget https://launchpad.net/galera/2.x/25.2.8/+download/galera-25.2.8-1.rhel6.x86_64.rpm
#rpm2cpio galera-25.2.8-1.rhel6.x86_64.rpm | cpio -idmv

#cp -Hr $OPENSHIFT_MARIADB_DIR/versions/$version/conf $OPENSHIFT_MARIADB_DIR/conf
#ln -s $OPENSHIFT_MARIADB_DIR/versions/$version/lib $OPENSHIFT_MARIADB_DIR/lib


mkdir -p $OPENSHIFT_MARIADB_DIR/{log,pid,socket,data,run}

cp $OPENSHIFT_MARIADB_DIR/conf/my.cnf.erb $OPENSHIFT_MARIADB_DIR/conf/my.cnf.erb.hidden

update_configuration $version
