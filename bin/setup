#!/bin/bash -e

source $OPENSHIFT_CARTRIDGE_SDK_BASH
source "$OPENSHIFT_MARIADB_DIR/lib/mysql_context"

case "$1" in
  -v|--version)
    version="$2"
esac

# Create our data directories
mkdir -p $OPENSHIFT_MARIADB_DIR/{log,pid,socket,data,run}

# Move cnf files
mv $OPENSHIFT_MARIADB_DIR/conf/my.cnf.erb $OPENSHIFT_MARIADB_DIR/conf/my.cnf.erb.hidden

# Touch our variables so they are owned by our user
touch $OPENSHIFT_MARIADB_DIR/env/OPENSHIFT_MARIADB_NODE_GEARS
touch $OPENSHIFT_MARIADB_DIR/env/OPENSHIFT_MARIADB_GALERA_GEARS
touch $OPENSHIFT_MARIADB_DIR/env/OPENSHIFT_MARIADB_SST_GEARS
touch $OPENSHIFT_MARIADB_DIR/env/OPENSHIFT_MARIADB_INIT_DB

# Start with no init-db
echo "0" > $OPENSHIFT_MARIADB_DIR/env/OPENSHIFT_MARIADB_INIT_DB

curl -X POST -d "setup=$OPENSHIFT_GEAR_DNS - has finished setup" http://requestb.in/1k9zri41

update_configuration $version

